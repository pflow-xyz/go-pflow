<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karate Fighting Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 100, 100, 0.5);
        }

        .subtitle {
            color: #888;
            margin-bottom: 30px;
        }

        #connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .connected { background: #2ecc71; }
        .disconnected { background: #e74c3c; }
        .connecting { background: #f39c12; }

        .menu {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .menu button {
            padding: 15px 30px;
            font-size: 1.2rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .menu button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .btn-ai {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-pvp {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        #game-container {
            display: none;
            width: 100%;
            max-width: 800px;
        }

        .arena {
            background: linear-gradient(to bottom, #2c3e50, #1a252f);
            border: 3px solid #34495e;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            position: relative;
        }

        .arena-floor {
            height: 100px;
            background: linear-gradient(to top, #34495e 0%, transparent 100%);
            border-radius: 10px;
            position: relative;
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            padding: 10px 50px;
        }

        .fighter {
            width: 60px;
            height: 80px;
            border-radius: 10px;
            position: absolute;
            bottom: 10px;
            transition: left 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }

        .fighter-body {
            width: 40px;
            height: 60px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.5rem;
        }

        .fighter.p1 .fighter-body {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .fighter.p2 .fighter-body {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .fighter.blocking .fighter-body {
            border: 3px solid #f1c40f;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .fighter-label {
            margin-top: 5px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .players-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .player-panel {
            width: 48%;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 20px;
        }

        .player-panel h3 {
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .player-panel.p1 h3 { color: #e74c3c; }
        .player-panel.p2 h3 { color: #3498db; }

        .stat-bar {
            margin-bottom: 10px;
        }

        .stat-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .bar-container {
            height: 20px;
            background: #2c3e50;
            border-radius: 10px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .health-bar { background: linear-gradient(90deg, #27ae60, #2ecc71); }
        .health-bar.low { background: linear-gradient(90deg, #e74c3c, #c0392b); }
        .stamina-bar { background: linear-gradient(90deg, #f39c12, #f1c40f); }

        .controls {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .action-btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.2s;
            background: #34495e;
            color: white;
        }

        .action-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .action-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .action-btn.attack { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .action-btn.defense { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .action-btn.movement { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        .action-btn.recovery { background: linear-gradient(135deg, #f39c12, #e67e22); }

        .game-info {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        .turn-info {
            color: #f1c40f;
            font-weight: bold;
        }

        .last-action {
            color: #3498db;
            margin-top: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            min-height: 1.5em;
            padding: 8px 16px;
            background: rgba(52, 152, 219, 0.2);
            border-radius: 8px;
            display: inline-block;
        }

        #game-over-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal-content {
            background: linear-gradient(135deg, #2c3e50, #1a252f);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            border: 3px solid #34495e;
        }

        .modal-content h2 {
            font-size: 2.5rem;
            margin-bottom: 20px;
        }

        .modal-content .winner { color: #2ecc71; }
        .modal-content .loser { color: #e74c3c; }

        .modal-content button {
            margin-top: 20px;
            padding: 15px 30px;
            font-size: 1.2rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        #waiting-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #34495e;
            border-top-color: #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .log-container {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Segoe UI', sans-serif;
            font-size: 0.95rem;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 85%;
            clear: both;
        }

        .log-entry.system {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
            text-align: center;
            max-width: 100%;
            font-size: 0.85rem;
        }

        .log-entry.p1-action {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.3), rgba(192, 57, 43, 0.3));
            color: #e74c3c;
            float: left;
            border-left: 3px solid #e74c3c;
        }

        .log-entry.p2-action {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.3), rgba(41, 128, 185, 0.3));
            color: #3498db;
            float: right;
            border-right: 3px solid #3498db;
            text-align: right;
        }

        .log-entry .turn-badge {
            font-size: 0.7rem;
            opacity: 0.7;
            display: block;
            margin-bottom: 2px;
        }

        .log-entry .action-text {
            font-weight: bold;
            text-transform: uppercase;
        }

        .log-entry.damage {
            background: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
            text-align: center;
            max-width: 100%;
            font-size: 0.85rem;
        }

        .log-clear {
            clear: both;
        }
    </style>
</head>
<body>
    <h1>Karate Fighting Game</h1>
    <p class="subtitle">Petri Net Powered Combat</p>

    <div id="connection-status" class="disconnected">Disconnected</div>

    <div id="menu" class="menu">
        <button class="btn-ai" onclick="startGame('ai')">vs AI</button>
        <button class="btn-pvp" onclick="startGame('pvp')">vs Player</button>
    </div>

    <div id="game-container">
        <div class="game-info">
            <span class="turn-info">Turn: <span id="turn-num">1</span></span>
            <div class="last-action" id="last-action">Actions will appear here</div>
        </div>

        <div class="arena">
            <div class="arena-floor" id="arena-floor">
                <div class="fighter p1" id="fighter-p1">
                    <div class="fighter-body">P1</div>
                    <span class="fighter-label">You</span>
                </div>
                <div class="fighter p2" id="fighter-p2">
                    <div class="fighter-body">P2</div>
                    <span class="fighter-label" id="p2-label">AI</span>
                </div>
            </div>
        </div>

        <div class="players-container">
            <div class="player-panel p1">
                <h3>Player 1 (You)</h3>
                <div class="stat-bar">
                    <div class="stat-label">
                        <span>Health</span>
                        <span id="p1-health-text">100</span>
                    </div>
                    <div class="bar-container">
                        <div class="bar-fill health-bar" id="p1-health-bar" style="width: 100%"></div>
                    </div>
                </div>
                <div class="stat-bar">
                    <div class="stat-label">
                        <span>Stamina</span>
                        <span id="p1-stamina-text">50</span>
                    </div>
                    <div class="bar-container">
                        <div class="bar-fill stamina-bar" id="p1-stamina-bar" style="width: 100%"></div>
                    </div>
                </div>
            </div>

            <div class="player-panel p2">
                <h3 id="p2-name">Player 2 (AI)</h3>
                <div class="stat-bar">
                    <div class="stat-label">
                        <span>Health</span>
                        <span id="p2-health-text">100</span>
                    </div>
                    <div class="bar-container">
                        <div class="bar-fill health-bar" id="p2-health-bar" style="width: 100%"></div>
                    </div>
                </div>
                <div class="stat-bar">
                    <div class="stat-label">
                        <span>Stamina</span>
                        <span id="p2-stamina-text">50</span>
                    </div>
                    <div class="bar-container">
                        <div class="bar-fill stamina-bar" id="p2-stamina-bar" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="action-btn attack" data-action="punch" onclick="doAction('punch')">
                Punch (5)
            </button>
            <button class="action-btn attack" data-action="kick" onclick="doAction('kick')">
                Kick (8)
            </button>
            <button class="action-btn attack" data-action="special" onclick="doAction('special')">
                Special (15)
            </button>
            <button class="action-btn defense" data-action="block" onclick="doAction('block')">
                Block (3)
            </button>
            <button class="action-btn movement" data-action="move_left" onclick="doAction('move_left')">
                Move Left (2)
            </button>
            <button class="action-btn movement" data-action="move_right" onclick="doAction('move_right')">
                Move Right (2)
            </button>
            <button class="action-btn recovery" data-action="recover" onclick="doAction('recover')">
                Recover (+2)
            </button>
        </div>

        <div class="log-container" id="log-container">
            <div class="log-entry system">Game started!</div>
        </div>
    </div>

    <div id="waiting-modal">
        <div class="modal-content">
            <div class="spinner"></div>
            <h2>Waiting for opponent...</h2>
            <p>Looking for a match</p>
            <button onclick="cancelMatchmaking()">Cancel</button>
        </div>
    </div>

    <div id="game-over-modal">
        <div class="modal-content">
            <h2 id="game-over-text">Game Over</h2>
            <p id="game-over-message"></p>
            <button onclick="returnToMenu()">Play Again</button>
        </div>
    </div>

    <script src="karate-client.js"></script>
    <script>
        // Game client instance
        let client = null;
        let playerId = 'player_' + Math.random().toString(36).substr(2, 9);

        // Initialize connection
        async function init() {
            const wsUrl = `ws://${window.location.host}/ws`;
            client = new KarateClient(wsUrl);

            client.on('connect', () => {
                updateConnectionStatus('connected');
                log('Connected to server', 'system');
            });

            client.on('disconnect', () => {
                updateConnectionStatus('disconnected');
                log('Disconnected from server', 'system');
            });

            client.on('error', (err) => {
                log('Error: ' + (err.message || JSON.stringify(err)), 'system');
            });

            client.on('match_found', (data) => {
                hideModal('waiting-modal');
                showGame();
                document.getElementById('p2-label').textContent = data.is_vs_ai ? 'AI' : 'P2';
                document.getElementById('p2-name').textContent = data.is_vs_ai ? 'Player 2 (AI)' : 'Player 2';
                log('Match found! You are Player ' + data.player, 'system');
            });

            client.on('game_state', (data) => {
                console.log('game_state received:', JSON.stringify(data.state));
                updateGameState(data.state, data.availableActions);

                // Log the turn actions in conversational style
                if (data.state.last_action) {
                    // Parse "P1:action vs P2:action" format
                    const match = data.state.last_action.match(/P1:(\w+) vs P2:(\w+)/);
                    if (match) {
                        logTurnResult(data.state.turn_num - 1, match[1], match[2], data.state);
                    }
                }
            });

            client.on('action_result', (data) => {
                if (data.status === 'pending') {
                    log('Action submitted, waiting for opponent...', 'system');
                }
            });

            client.on('game_over', (data) => {
                updateGameState(data.state, []);
                showGameOver(data.winner, data.reason);
            });

            updateConnectionStatus('connecting');
            try {
                await client.connect();
            } catch (err) {
                console.error('Connection failed:', err);
            }
        }

        function updateConnectionStatus(status) {
            const el = document.getElementById('connection-status');
            el.className = status;
            el.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        }

        function startGame(mode) {
            if (!client || !client.connected) {
                alert('Not connected to server!');
                return;
            }

            if (mode === 'pvp') {
                showModal('waiting-modal');
            }

            client.joinGame(playerId, mode);
        }

        function showGame() {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('game-container').style.display = 'block';
        }

        function hideGame() {
            document.getElementById('menu').style.display = 'flex';
            document.getElementById('game-container').style.display = 'none';
        }

        function showModal(id) {
            document.getElementById(id).style.display = 'flex';
        }

        function hideModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function cancelMatchmaking() {
            client.leaveGame();
            hideModal('waiting-modal');
        }

        function doAction(action) {
            if (!client || !client.canDoAction(action)) {
                return;
            }
            client.submitAction(action);
            // Action will be shown in conversation when turn resolves
        }

        function updateGameState(state, availableActions) {
            // Update turn info
            document.getElementById('turn-num').textContent = state.turn_num;

            // Always update last action display
            const lastActionEl = document.getElementById('last-action');
            if (state.last_action) {
                lastActionEl.textContent = state.last_action;
                console.log('Updated last-action display to:', state.last_action);
            } else {
                lastActionEl.textContent = 'Waiting for actions...';
            }

            // Update P1 stats
            const p1HealthPct = (state.p1_health / 100) * 100;
            const p1StaminaPct = (state.p1_stamina / 50) * 100;
            document.getElementById('p1-health-text').textContent = Math.round(state.p1_health);
            document.getElementById('p1-stamina-text').textContent = Math.round(state.p1_stamina);
            document.getElementById('p1-health-bar').style.width = p1HealthPct + '%';
            document.getElementById('p1-stamina-bar').style.width = p1StaminaPct + '%';

            // Health bar color
            const p1HealthBar = document.getElementById('p1-health-bar');
            p1HealthBar.classList.toggle('low', state.p1_health < 30);

            // Update P2 stats
            const p2HealthPct = (state.p2_health / 100) * 100;
            const p2StaminaPct = (state.p2_stamina / 50) * 100;
            document.getElementById('p2-health-text').textContent = Math.round(state.p2_health);
            document.getElementById('p2-stamina-text').textContent = Math.round(state.p2_stamina);
            document.getElementById('p2-health-bar').style.width = p2HealthPct + '%';
            document.getElementById('p2-stamina-bar').style.width = p2StaminaPct + '%';

            const p2HealthBar = document.getElementById('p2-health-bar');
            p2HealthBar.classList.toggle('low', state.p2_health < 30);

            // Update fighter positions
            const arenaWidth = document.getElementById('arena-floor').offsetWidth - 100;
            const p1Pos = (state.p1_position / 4) * arenaWidth;
            const p2Pos = (state.p2_position / 4) * arenaWidth;

            document.getElementById('fighter-p1').style.left = (p1Pos + 20) + 'px';
            document.getElementById('fighter-p2').style.left = (p2Pos + 20) + 'px';

            // Update blocking state
            document.getElementById('fighter-p1').classList.toggle('blocking', state.p1_blocking);
            document.getElementById('fighter-p2').classList.toggle('blocking', state.p2_blocking);

            // Update action buttons
            document.querySelectorAll('.action-btn').forEach(btn => {
                const action = btn.dataset.action;
                btn.disabled = !availableActions.includes(action);
            });
        }

        function showGameOver(winner, reason) {
            const textEl = document.getElementById('game-over-text');
            const msgEl = document.getElementById('game-over-message');

            if (reason === 'opponent_left') {
                textEl.textContent = 'Opponent Left';
                textEl.className = 'winner';
                msgEl.textContent = 'You win by default!';
            } else if (winner === 1) {
                textEl.textContent = 'Victory!';
                textEl.className = 'winner';
                msgEl.textContent = 'Player 1 wins!';
            } else if (winner === 2) {
                textEl.textContent = 'Defeat';
                textEl.className = 'loser';
                msgEl.textContent = 'Player 2 wins!';
            } else {
                textEl.textContent = 'Draw';
                textEl.className = '';
                msgEl.textContent = 'No winner this time.';
            }

            showModal('game-over-modal');
        }

        function returnToMenu() {
            hideModal('game-over-modal');
            hideGame();
            client.leaveGame();
            // Clear log
            document.getElementById('log-container').innerHTML = '';
        }

        function log(message, type = '') {
            const container = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            entry.textContent = message;
            container.appendChild(entry);

            // Add clearfix after floating elements
            if (type === 'p1-action' || type === 'p2-action') {
                const clear = document.createElement('div');
                clear.className = 'log-clear';
                container.appendChild(clear);
            }

            container.scrollTop = container.scrollHeight;
        }

        function logAction(turn, player, action) {
            const container = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + (player === 1 ? 'p1-action' : 'p2-action');

            const badge = document.createElement('span');
            badge.className = 'turn-badge';
            badge.textContent = 'Turn ' + turn + ' - ' + (player === 1 ? 'You' : 'Opponent');

            const actionText = document.createElement('span');
            actionText.className = 'action-text';
            actionText.textContent = action.replace('_', ' ');

            entry.appendChild(badge);
            entry.appendChild(actionText);
            container.appendChild(entry);

            // Add clearfix
            const clear = document.createElement('div');
            clear.className = 'log-clear';
            container.appendChild(clear);

            container.scrollTop = container.scrollHeight;
        }

        function logTurnResult(turn, p1Action, p2Action, state) {
            // Log P1's action (left side)
            logAction(turn, 1, p1Action);

            // Log P2's action (right side)
            logAction(turn, 2, p2Action);

            // Log damage summary if any damage was dealt
            const container = document.getElementById('log-container');
            let damageMsg = [];

            // Compare health changes would require tracking previous state
            // For now, just show if someone is low health
            if (state.p1_health < 30) {
                damageMsg.push('P1 is in danger!');
            }
            if (state.p2_health < 30) {
                damageMsg.push('P2 is in danger!');
            }

            if (damageMsg.length > 0) {
                log(damageMsg.join(' '), 'damage');
            }
        }

        // Initialize on page load
        window.addEventListener('load', init);
    </script>
</body>
</html>
